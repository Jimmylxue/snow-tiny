"use strict";var e=require("chalk"),t=require("path"),r=require("fs"),n=require("os"),o=require("single-line-log"),i=require("ora");function s(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var l,u=s(e),c=s(n),a=s(o),d=s(i);function f(e){const r=t.extname(e);return[".png",".jpeg",".jpg"].includes(r)}function p(e,t=["png","jpg","jpeg"]){return new RegExp(`.(${t.join("|")})$`).test(e)}function h(e=0){if(0===e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return(e/Math.pow(1024,t)).toPrecision(3)+" "+l[t]}function g(e,t,n=()=>{}){const o=r.createReadStream(e),i=r.createWriteStream(t);o.pipe(i),i.on("close",n)}!function(e){e[e.B=0]="B",e[e.KB=1]="KB",e[e.MB=2]="MB",e[e.GB=3]="GB",e[e.TB=4]="TB",e[e.PB=5]="PB",e[e.EB=6]="EB",e[e.ZB=7]="ZB",e[e.YB=8]="YB"}(l||(l={})),Buffer.from("tiny","binary");const m=a.default.stdout;let $=(e,t,r)=>e.replace(new RegExp(`:${t}`,"g"),r);let B;function y(e,t,n,o){const{diffCompress:i,acceptPictureType:s}=o;B=d.default(),B.info(`正在搜索 「${u.default.blueBright(n)}」 ......`),t.dirRoute=e,t.dirname=n;let l=r.readdirSync(e);l?l.map((n=>{if(l=e+"/"+n,r.lstatSync(l).isDirectory()){if(t.dirChildren||(t.dirChildren=[]),t.dirChildren.find((e=>e.dirRoute===n))||t.dirChildren.push({dirRoute:n}),!i)return;y(e+"/"+n,t.dirChildren?.find((e=>e.dirRoute===n)),n,o)}else t.fileChildren||(t.fileChildren=[]),n.startsWith(".")||t.fileChildren?.push({isDir:!1,isImage:f(n),isAcceptImage:p(n,s),fileName:n,fullRoute:e+"/"+n,outputRoute:""});var l})):console.warn("空目录"),B.stop()}function b(e,t,n,o){const{saveOther:i}=o;r.mkdirSync(t),e.fileChildren?.map((e=>{const{fileName:r,fullRoute:o,isAcceptImage:s}=e;e.isImage?s?n.push({...e,outputRoute:`${t}/${r}`}):(e.outputRoute=`${t}/${r}`,g(o,`${t}/${r}`,(()=>{B.succeed(`非接受的压缩的图片-写入完成：${u.default.blueBright(r)}`)}))):i&&(e.outputRoute=`${t}/${r}`,g(o,`${t}/${r}`,(()=>{B.succeed(`非图片资源-写入完成：${u.default.blueBright(r)}`)})))})),o?.diffCompress&&e.dirChildren?.map((e=>{b(e,t+"/"+e.dirname,n,o)}))}const w=require("cluster"),k=c.default.cpus().length,j=require("console-grid");let C,R;const q=new class{constructor(e="Loading...",t){this.description=e,"number"==typeof t?(this.length=t||50,this.incomplete="░",this.complete="█"):t instanceof Object&&"[object Object]"===Object.prototype.toString.call(t)?(this.length=t.width||50,this.incomplete=t.incomplete||"░",this.complete=t.complete||"█"):(this.length=50,this.incomplete="░",this.complete="█")}render(e={}){try{let{current:t=0,total:r=10}=e;if(r<=0||isNaN(r)||isNaN(t))return!1;let n=Math.floor(t/r*this.length),o=[...new Array(this.length)].map(((e,t)=>t<=n-1?this.complete:this.incomplete)).join(""),i=`${(t/r*100).toFixed(2)}%`,s=["bar","percent"],l=this.description,u=[];for(const t in e)Object.hasOwnProperty.call(e,t)&&!s.includes(t)&&u.push([t,e[t]]);u.sort(((e,t)=>t[0].length-e[0].length)).forEach((([e,t])=>{l=$(l,e,t)})),l=$(l,"percent",i),l=$(l,"current",t),l=$(l,"total",r),l=$(l,"bar",o),m(l)}catch{}}}("progress :percent  :token :bar  :current/:total \n",50);let E,v=0,x=0,M=0;const N=[];function O(e,r){C=d.default(),R=d.default();const n={};return y(t.resolve(process.cwd(),`${e}`),n,e,E),b(n,t.resolve(process.cwd(),`${r}`),N,E),R.succeed(`共扫描到 ${u.default.blueBright(N.length)} 个文件`),function(e){w.setupPrimary({exec:t.resolve(__dirname,"core/process.js")});const r=[];if(e.length<=k)r.push({work:w.fork(),tasks:e});else for(let e=0;e<k;e++){const e=w.fork();r.push({work:e,tasks:[]})}let n=0;e.forEach((e=>{1!==r.length&&(n>=r.length?(r[0].tasks.push(e),n=1):(r[n].tasks.push(e),n+=1))}));let o=r.length,i=0,s=0;const l=[];let c=[];r.forEach((({work:t,tasks:r})=>{t.send({tasks:r,snowTinyConfig:E}),t.on("message",(t=>{if(c=c.concat(t),t.forEach((t=>{t.output?(v+=t.input,x+=t.output,M+=t.ratio,i++):(s++,t.msg&&l.push(t.msg)),q.render({current:i+s,total:e.length,token:`共${u.default.blueBright(N.length)}文件 ${u.default.green(i)} 个成功  ${u.default.red(s)} 个失败`})})),o--,0===o){l.length&&l.forEach((e=>{console.log("error：",e)})),j({options:{headerVisible:!0},columns:["名称","原体积","现体积","压缩率","耗时","状态"],rows:[...c.map((e=>[u.default.blue(e.fileName),u.default.red(h(e.input)),u.default.yellow(h(e.output)),e.ratio?u.default.green((100*e.ratio).toFixed(4)+" %"):u.default.red("0 %"),u.default.cyan(e.time+" ms"),e.output?u.default.green("success"):u.default.red("fail")]))]});const e=0===i?0:M/i;C.succeed(`压缩完成：\n 输出图片总大小：${u.default.red(h(v))} \n 输入图片总大小：${u.default.green(h(x))} \n 综合压缩率：${u.default.green((100*e).toFixed(4)+" %")}`),w.disconnect()}}))}))}(N),n}module.exports=()=>{E=require(t.resolve(process.cwd(),"snowtiny.json")),O(E.entry,E.output)};
